#!/usr/bin/env ruby

require 'json'
require 'shellwords'

DEBUG = false

# Read JSON input from stdin
input = JSON.parse($stdin.read)

# Debug: print full JSON to stdout
if DEBUG
  puts "input = #{JSON.generate(input)}"
  _example_json = {
    "session_id": 'abc',
    "transcript_path": '/Users/user/.claude/projects/some.jsonl',
    "cwd": '/Users/user/dev/dotfiles',
    "model": {
      "id": 'us.anthropic.claude-sonnet-4-5-20250929-v1:0',
      "display_name": 'Sonnet 4.5'
    },
    "workspace": {
      "current_dir": '/Users/user/dev/dotfiles',
      "project_dir": '/Users/user/dev/dotfiles'
    },
    "version": '2.0.64',
    "output_style": {
      "name": 'default'
    },
    "cost": {
      "total_cost_usd": 0.2780467,
      "total_duration_ms": 492_396,
      "total_api_duration_ms": 168_356,
      "total_lines_added": 22,
      "total_lines_removed": 3
    },
    "exceeds_200k_tokens": false
  }
  puts "\n---\n"
end

# Extract data
model_name = input.dig('model', 'display_name')
current_dir = input.dig('workspace', 'current_dir')
cost = input.dig('cost', 'total_cost_usd')
# context_input = input.dig('context_window', 'total_input_tokens')
# context_output = input.dig('context_window', 'total_output_tokens')
# context_size = input.dig('context_window', 'context_window_size')

# Parse model name (handles various formats)
# e.g., "us.anthropic.claude-sonnet-4-5-20250929-v1:0" -> "sonnet 4.5"
# e.g., "Sonnet 4.5" -> "sonnet 4.5"
if model_name =~ /claude-(\w+)-(\d+)-(\d+)/
  # Extract from full model ID format
  family = Regexp.last_match(1)  # sonnet, opus, haiku
  major = Regexp.last_match(2)   # 4
  minor = Regexp.last_match(3)   # 5
  model_display = "#{family} #{major}.#{minor}"
else
  # Already in friendly format, just lowercase it
  model_display = model_name.downcase
end

# Convert to relative path from home (like %~ in zsh)
relative_dir = current_dir.sub(/^#{ENV['HOME']}/, '~')

# Get git branch
git_branch = ''
if system("git -C #{current_dir.shellescape} rev-parse --git-dir > /dev/null 2>&1")
  git_branch = `git -C #{current_dir.shellescape} --no-optional-locks branch --show-current 2>/dev/null`.strip
end

# Build status line matching your prompt style
# Reset color at the start for a clean baseline
status = "\033[0m"

# Model name with cost
if cost && cost != 0
  # Round to whole dollars
  cost_rounded = cost.round
  model_display = "#{model_display} \033[32m$#{cost_rounded}\033[0m"
end
status += "\033[36m#{model_display}\033[0m"

# Relative path
status += " #{relative_dir}"

# Yellow git branch in parens (like your prompt)
status += "\033[33m(#{git_branch})\033[0m" unless git_branch.empty?

# AI emoji separator - options: ðŸ¤– âœ¨ ðŸ§  âš¡ ðŸ”®
status += ' ðŸ¤–'

# Add context info if available
# if context_input && context_output && context_size
#   # Format as "5% 10k/200k" style (percent used, consumed/total)
#   used = context_input + context_output
#   used_pct = (used.to_f / context_size * 100).round
#   used_k = (used / 1000.0).round
#   size_k = (context_size / 1000.0).round
#   status += " \033[35m#{used_pct}% #{used_k}k/#{size_k}k\033[0m"
# end

puts status
